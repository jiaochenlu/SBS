<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Experiment Detail - Search NDCG Experiment</title>
    <link rel="stylesheet" href="experiment-detail.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="experiment-info">
                <h1 class="experiment-title" id="experimentTitle">Loading...</h1>
                <div class="experiment-meta">
                    <span class="status-badge" id="experimentStatus">Loading...</span>
                    <span id="experimentCreated">Created: Loading...</span>
                    <span id="experimentOwner">Owner: Loading...</span>
                    <span id="experimentQueryCount">Loading queries...</span>
                </div>
            </div>
            <div class="header-right">
                <!-- User Switcher -->
                <div class="user-switcher">
                    <div class="current-user" onclick="toggleUserDropdown()">
                        <div class="user-avatar" id="currentUserAvatar">JS</div>
                        <div class="user-info">
                            <div class="user-name" id="currentUserName">John Smith</div>
                            <div class="user-role" id="currentUserRole">Owner</div>
                        </div>
                        <span class="dropdown-arrow">‚ñº</span>
                    </div>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="user-option" onclick="switchUser('john-smith')">
                            <div class="user-avatar">JS</div>
                            <div class="user-info">
                                <div class="user-name">John Smith</div>
                                <div class="user-role">Owner</div>
                            </div>
                        </div>
                        <div class="user-option" onclick="switchUser('sarah-chen')">
                            <div class="user-avatar">SC</div>
                            <div class="user-info">
                                <div class="user-name">Sarah Chen</div>
                                <div class="user-role">Co-Owner</div>
                            </div>
                        </div>
                        <div class="user-option" onclick="switchUser('alice-miller')">
                            <div class="user-avatar">AM</div>
                            <div class="user-info">
                                <div class="user-name">Alice Miller</div>
                                <div class="user-role">Judge</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="header-actions">
                    <button class="btn-header" onclick="toggleConfigurationPanel()" id="configBtn" title="View configuration">üìã Configuration</button>
                    <button class="btn-header" onclick="cloneExperiment()" id="cloneBtn" title="Clone experiment">üìã Clone</button>
                    <button class="btn-header btn-danger-header" onclick="deleteExperiment()" id="deleteBtn" title="Delete experiment">üóëÔ∏è Delete</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Content Wrapper with matching background -->
    <div class="content-wrapper">
        <!-- Overview Section -->
        <div class="overview-section">
            <div class="content-container">
                <!-- Progress Section -->
                <div class="section-card progress-overview-card">
                    <div class="section-header progress-header">
                        <h3>Progress Overview</h3>
                        <div class="progress-percentage" id="totalQueriesDisplay">Loading Total Queries</div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar-segmented">
                            <div class="progress-segment completed" id="progressCompleted" style="width: 0%" title="Loading..."></div>
                            <div class="progress-segment in-progress" id="progressInProgress" style="width: 0%" title="Loading..."></div>
                            <div class="progress-segment not-started" id="progressNotStarted" style="width: 0%" title="Loading..."></div>
                        </div>
                        <div class="progress-stats-row">
                            <div class="progress-stats">
                                <div class="progress-stat-item completed">
                                    <span class="stat-dot"></span>
                                    <span class="stat-text" id="completedStat">Loading Completed</span>
                                </div>
                                <div class="progress-stat-item in-progress">
                                    <span class="stat-dot"></span>
                                    <span class="stat-text" id="inProgressStat">Loading In Progress</span>
                                </div>
                                <div class="progress-stat-item not-started">
                                    <span class="stat-dot"></span>
                                    <span class="stat-text" id="notStartedStat">Loading Not Started</span>
                                </div>
                            </div>
                            <div class="judges-info">
                                <span class="judges-icon">üë•</span>
                                <span class="stat-text" id="judgesCount">Loading Judges</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="tab-navigation">
            <div class="tab-container">
                <button class="tab-button active" data-tab="queries" onclick="switchTab('queries')">
                    Queries
                    <span class="tab-badge" id="queriesTabBadge">0</span>
                </button>
                <button class="tab-button" data-tab="results" onclick="switchTab('results')">
                    Results
                </button>
                <button class="tab-button" data-tab="members" onclick="switchTab('members')">
                    Members
                    <span class="tab-badge" id="membersTabBadge">0</span>
                </button>
            </div>
        </div>

        <!-- Main Content with Right Panel Layout -->
        <div class="main-content-wrapper">
            <div class="main-content">
        
        <!-- Queries Tab -->
        <div id="queries-tab" class="tab-content active">
            <div class="content-container">
                <div class="section-header">
                    <div class="header-left">
                        <h3>Query Management</h3>
                        <div class="header-actions">
                            <button class="btn-primary" id="assignJudgesBtn" onclick="assignQueries()" disabled>Assign Judges</button>
                            <button class="btn-secondary" onclick="importQueries()">Import Queries</button>
                        </div>
                    </div>
                </div>

                <!-- Task Type Sidebar and Query Content Layout -->
                <div class="query-management-layout">
                    <!-- Task Type Sidebar (only for ad hoc experiments) -->
                    <div class="task-type-sidebar" id="taskTypeSidebar" style="display: none;">
                        <div class="sidebar-header">
                            <h4>Task Types</h4>
                            <button class="clear-filter-btn" onclick="clearTaskTypeFilter()" title="Show all queries">
                                Clear Filter
                            </button>
                        </div>
                        <div class="task-type-list" id="taskTypeList">
                            <!-- Task types will be dynamically loaded here -->
                        </div>
                    </div>

                    <!-- Main Query Content -->
                    <div class="query-content-area">
                        <!-- Filters and Search -->
                        <div class="filters-section">
                            <div class="search-box">
                                <input type="text" placeholder="Search queries..." class="search-input">
                                <button class="search-btn">üîç</button>
                            </div>
                            <div class="filter-buttons">
                                <select class="filter-select">
                                    <option value="">All Status</option>
                                    <option value="completed">Completed</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="not-started">Not Started</option>
                                </select>
                                <select class="filter-select">
                                    <option value="">All Judges</option>
                                    <option value="john-smith">John Smith</option>
                                    <option value="alice-miller">Alice Miller</option>
                                    <option value="robert-johnson">Robert Johnson</option>
                                </select>
                            </div>
                        </div>

                        <!-- Query List -->
                        <div class="query-list-container">
                            <div class="query-list-header" id="queryListHeader">
                                <!-- Header will be rendered by JS -->
                            </div>
                            
                            <div class="query-list-body" id="queryListBody">
                                <!-- Query items will be dynamically loaded here -->
                            </div>
                        </div>

                        <!-- Pagination -->
                        <div class="pagination">
                            <button class="pagination-btn" onclick="previousPage()">‚Üê Previous</button>
                            <span class="pagination-info">Page 1 of 10</span>
                            <button class="pagination-btn" onclick="nextPage()">Next ‚Üí</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Members Tab -->
        <div id="members-tab" class="tab-content">
            <div class="content-container">
                <div class="section-header">
                    <h3>Team Members</h3>
                    <div class="header-actions">
                        <button class="btn-primary" onclick="addMember()">Add Member</button>
                        <button class="btn-secondary" onclick="manageMembers()">Manage Members</button>
                    </div>
                </div>

                <!-- Members List -->
                <div class="members-grid">
                    <!-- Members will be dynamically loaded here -->
                </div>

                <!-- Add Member Modal -->
                <div id="addMemberModal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Add New Member</h3>
                            <button class="modal-close" onclick="closeAddMemberModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Email Address</label>
                                <input type="email" class="form-control" placeholder="Enter email address">
                            </div>
                            <div class="form-group">
                                <label>Role</label>
                                <select class="form-control" id="roleSelect">
                                    <!-- Options will be populated dynamically based on current user role -->
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeAddMemberModal()">Cancel</button>
                            <button class="btn-primary" onclick="addMemberSubmit()">Add Member</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Tab -->
        <div id="results-tab" class="tab-content">
            <div class="content-container">
                <div class="section-header">
                    <h3>Annotation Results</h3>
                    <div class="header-actions">
                        <button class="btn-secondary" onclick="downloadReport()">Download Report</button>
                        <button class="btn-primary" onclick="exportData()">Export Data</button>
                    </div>
                </div>

                <!-- Results Summary -->
                <div class="results-summary">
                    <div class="summary-card">
                        <div class="summary-title">Inter-Annotator Agreement</div>
                        <div class="summary-value">87.3%</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">Average Completion Time</div>
                        <div class="summary-value">2.3 min</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">Quality Score</div>
                        <div class="summary-value">9.1/10</div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="charts-section">
                    <div class="chart-container">
                        <h4>Completion Progress Over Time</h4>
                        <div class="chart-placeholder">üìà Chart will be rendered here</div>
                    </div>
                    <div class="chart-container">
                        <h4>Answer Distribution</h4>
                        <div class="chart-placeholder">üìä Chart will be rendered here</div>
                    </div>
                </div>
            </div>
        </div>

            <!-- Right Panel for Configuration -->
            <div class="right-panel" id="configurationPanel">
                <div class="right-panel-header">
                    <h3>Experiment Configuration</h3>
                    <button class="panel-close" onclick="toggleConfigurationPanel()">&times;</button>
                </div>
                <div class="right-panel-body">
                    <div class="config-section">
                        <h4>Experiment Type</h4>
                        <div class="config-item">
                            <span class="config-label">Selected Type:</span>
                            <span class="config-value" id="configExperimentType">Loading...</span>
                        </div>
                    </div>

                    <div class="config-section">
                        <h4>Basic Information</h4>
                        <div class="config-item">
                            <span class="config-label">Experiment Name:</span>
                            <span class="config-value" id="configExperimentName">Loading...</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">Experiment Description:</span>
                            <span class="config-value" id="configExperimentDescription">Loading...</span>
                        </div>
                    </div>

                    <div class="config-section">
                        <h4>Labeling Data</h4>
                        <div class="config-item">
                            <span class="config-label">Data Schema:</span>
                            <span class="config-value" id="configDataSchema">Loading...</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">Data Source:</span>
                            <span class="config-value" id="configDataSource">Loading...</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">Query Set Selection:</span>
                            <span class="config-value" id="configQuerySetSelection">Loading...</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">Query Set File:</span>
                            <span class="config-value" id="configQuerySetFile">Loading...</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">Control Profile:</span>
                            <span class="config-value" id="configControlProfile">Loading...</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">Treatment Profile:</span>
                            <span class="config-value" id="configTreatmentProfile">Loading...</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">Data Fields Display:</span>
                            <span class="config-value" id="configDataFieldsDisplay">Loading...</span>
                        </div>
                    </div>

                    <div class="config-section">
                        <h4>Judgement Questions</h4>
                        <div id="judgementQuestionsContainer">
                            <div class="config-item">
                                <span class="config-label">Loading...</span>
                                <span class="config-value">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <div class="config-section">
                        <h4>Additional Settings</h4>
                        <div class="config-item">
                            <span class="config-label">Blind Test:</span>
                            <span class="config-value" id="configBlindTest">Loading...</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">Allow Any to Judge:</span>
                            <span class="config-value" id="configAllowAnyToJudge">Loading...</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">Judgement Guide:</span>
                            <span class="config-value" id="configJudgementGuide">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="experiment-detail.js"></script>
    <script>
        // Immediate config loading and UI update
        (async function() {
            console.log('üöÄ Immediate config loader starting...');
            
            try {
                // Fetch config immediately
                const response = await fetch('./experiment-config-merged.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const config = await response.json();
                console.log('‚úÖ Config loaded immediately:', config);
                const exp = config.experiment;
                window.exp = exp; // ËÆ©ÂêéÁª≠ËÑöÊú¨ÂèØÁõ¥Êé•ËÆøÈóÆ
                
                // Update all hardcoded "Loading..." immediately
                const updates = [
                    { id: 'experimentTitle', value: exp.name },
                    { id: 'experimentStatus', value: exp.status.charAt(0).toUpperCase() + exp.status.slice(1) },
                    { id: 'experimentCreated', value: `Created: ${exp.createdAt}` },
                    { id: 'experimentOwner', value: `Owner: ${exp.owner.name}` },
                    { id: 'experimentQueryCount', value: `${exp.progress.totalQueries} queries` },
                    { id: 'totalQueriesDisplay', value: `${exp.progress.totalQueries} Total Queries` },
                    { id: 'completedStat', value: `${exp.progress.completed} Completed (${exp.progress.completedPercentage}%)` },
                    { id: 'inProgressStat', value: `${exp.progress.inProgress} In Progress (${exp.progress.inProgressPercentage}%)` },
                    { id: 'notStartedStat', value: `${exp.progress.notStarted} Not Started (${exp.progress.notStartedPercentage}%)` },
                    { id: 'judgesCount', value: `${exp.members.length} Judges` },
                    { id: 'configExperimentType', value: exp.configuration.experimentType },
                    { id: 'configExperimentName', value: exp.name },
                    { id: 'configExperimentDescription', value: exp.description },
                    { id: 'configDataSchema', value: exp.configuration.dataSchema },
                    { id: 'configDataSource', value: exp.configuration.dataSource },
                    { id: 'configQuerySetSelection', value: exp.configuration.querySetSelection },
                    { id: 'configQuerySetFile', value: `${exp.configuration.querySetFile.name} (${exp.configuration.querySetFile.queryCount} queries)` },
                    { id: 'configControlProfile', value: exp.configuration.controlProfile },
                    { id: 'configTreatmentProfile', value: exp.configuration.treatmentProfile },
                    { id: 'configDataFieldsDisplay', value: exp.configuration.dataFieldsDisplay },
                    { id: 'configBlindTest', value: exp.configuration.additionalSettings.blindTest ? 'Enabled' : 'Disabled' },
                    { id: 'configAllowAnyToJudge', value: exp.configuration.additionalSettings.allowAnyToJudge ? 'Enabled' : 'Disabled' },
                    { id: 'configJudgementGuide', value: exp.configuration.additionalSettings.judgementGuide },
                    { id: 'queriesTabBadge', value: exp.queries.length },
                    { id: 'membersTabBadge', value: exp.members.length }
                ];
                
                // Apply all updates
                updates.forEach(update => {
                    const element = document.getElementById(update.id);
                    if (element) {
                        element.textContent = update.value;
                        console.log(`‚úÖ Updated ${update.id} to: ${update.value}`);
                    } else {
                        console.warn(`‚ùå Element ${update.id} not found`);
                    }
                });
                
                // Update progress bars
                const progressCompleted = document.getElementById('progressCompleted');
                if (progressCompleted) {
                    progressCompleted.style.width = `${exp.progress.completedPercentage}%`;
                    progressCompleted.title = `${exp.progress.completed} Completed (${exp.progress.completedPercentage}%)`;
                }
                
                const progressInProgress = document.getElementById('progressInProgress');
                if (progressInProgress) {
                    progressInProgress.style.width = `${exp.progress.inProgressPercentage}%`;
                    progressInProgress.title = `${exp.progress.inProgress} In Progress (${exp.progress.inProgressPercentage}%)`;
                }
                
                const progressNotStarted = document.getElementById('progressNotStarted');
                if (progressNotStarted) {
                    progressNotStarted.style.width = `${exp.progress.notStartedPercentage}%`;
                    progressNotStarted.title = `${exp.progress.notStarted} Not Started (${exp.progress.notStartedPercentage}%)`;
                }
                
                // Update experiment status badge class
                const statusElement = document.getElementById('experimentStatus');
                if (statusElement) {
                    statusElement.className = `status-badge status-${exp.status}`;
                }
                
                console.log('üéâ All UI elements updated successfully!');
                
                // Load queries into the query list
                console.log('üìã Loading queries...');
                const queryListBody = document.getElementById('queryListBody');
                if (queryListBody && exp.queries) {
                    queryListBody.innerHTML = ''; // Clear existing content
                    
                    exp.queries.forEach(query => {
                        const row = document.createElement('div');
                        row.className = 'query-row';
                        
                        // Calculate progress for this query
                        const assignments = query.assignments || [];
                        const completedAssignments = assignments.filter(a => a.status === 'completed').length;
                        const totalAssignments = assignments.length;
                        
                        let overallStatus = 'not-started';
                        if (completedAssignments === totalAssignments && totalAssignments > 0) {
                            overallStatus = 'completed';
                        } else if (completedAssignments > 0) {
                            overallStatus = 'in-progress';
                        }
                        
                        const overallProgress = totalAssignments > 0 ? Math.round((completedAssignments / totalAssignments) * 100) : 0;
                        
                        // Create assignees display
                        const assigneesHtml = assignments.length > 0 ?
                            assignments.map(assignment => `
                                <div class="assignment-item" title="${assignment.judge.name} - ${assignment.status}">
                                    <div class="assignee-avatar ${assignment.status}">${assignment.judge.initials}</div>
                                    <div class="assignment-status-dot ${assignment.status}"></div>
                                </div>
                            `).join('') :
                            '<div class="no-assignments">Not assigned</div>';
                        
                        // Calculate last judged time
                        const completedAssignmentsForTime = assignments.filter(a => a.status === 'completed');
                        let lastJudgedAt = '--';
                        if (completedAssignmentsForTime.length > 0) {
                            const latestCompletion = completedAssignmentsForTime.reduce((latest, current) => {
                                const currentTime = new Date(current.completedAt).getTime();
                                const latestTime = new Date(latest.completedAt).getTime();
                                return currentTime > latestTime ? current : latest;
                            });
                            
                            const date = new Date(latestCompletion.completedAt);
                            lastJudgedAt = date.getFullYear() + '-' +
                                          String(date.getMonth() + 1).padStart(2, '0') + '-' +
                                          String(date.getDate()).padStart(2, '0') + ' ' +
                                          String(date.getHours()).padStart(2, '0') + ':' +
                                          String(date.getMinutes()).padStart(2, '0') + ':' +
                                          String(date.getSeconds()).padStart(2, '0');
                        }
                        
                        row.innerHTML = `
                            <div class="checkbox-column">
                                <input type="checkbox" value="${query.id}" onchange="updateSelectedQueries()">
                            </div>
                            <div class="query-column">
                                <div class="query-text">${query.text}</div>
                                <div class="query-meta">#${query.id}</div>
                            </div>
                            <div class="task-type-column">
                                <div class="task-type-text">${query.taskType || 'N/A'}</div>
                            </div>
                            <div class="assignments-column">
                                <div class="assignments-container">
                                    ${assigneesHtml}
                                </div>
                                <div class="assignment-summary">
                                    ${totalAssignments} assigned | ${completedAssignments} completed
                                </div>
                            </div>
                            <div class="status-column">
                                <span class="status-badge status-${overallStatus}">${overallStatus}</span>
                            </div>
                            <div class="last-judged-column">
                                ${lastJudgedAt}
                            </div>
                        `;
                        
                        queryListBody.appendChild(row);
                    });
                    
                    console.log(`‚úÖ Loaded ${exp.queries.length} queries`);
                } else {
                    console.warn('‚ùå queryListBody element not found or no queries in config');
                }
            
                
            } catch (error) {
                console.error('‚ùå Immediate config loading failed:', error);
                // Set fallback values if config loading fails
                const fallbackUpdates = [
                    { id: 'experimentTitle', value: 'Search NDCG Experiment (Fallback)' },
                    { id: 'experimentStatus', value: 'Active' },
                    { id: 'experimentCreated', value: 'Created: March 15, 2024' },
                    { id: 'experimentOwner', value: 'Owner: John Smith' },
                    { id: 'experimentQueryCount', value: '50 queries' },
                    { id: 'totalQueriesDisplay', value: '50 Total Queries' },
                    { id: 'completedStat', value: '30 Completed (60%)' },
                    { id: 'inProgressStat', value: '10 In Progress (20%)' },
                    { id: 'notStartedStat', value: '10 Not Started (20%)' },
                    { id: 'judgesCount', value: '3 Judges' }
                ];
                
                fallbackUpdates.forEach(update => {
                    const element = document.getElementById(update.id);
                    if (element) {
                        element.textContent = update.value;
                    }
                });
            }
        })();
    </script>
</body>
</html>
